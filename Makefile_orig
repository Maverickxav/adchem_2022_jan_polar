# compiler
F90 = gfortran

# Put .o and .mod files here:
OBJDIR = build
SRCDIR = src
CHEM_MAIN_DIR =	chemistries
ACDC_MAIN_DIR = ACDC_versions

CHEM_DIR=$(CHEM_MAIN_DIR)/mcm_PRAMv1_DMS_I2O5_HIO2
ACDC_DIR=$(ACDC_MAIN_DIR)/ACDC_AMsD_DLPNO
# When compiling, search for files in these directories:
VPATH = $(OBJDIR):src:$(CHEM_DIR):megan:M7_box
# VPATH = $(OBJDIR):mcm_PRAMv1_DMS_I2O5_HIO2 megan ACDC_AMsD_DLPNO  M7_box
# VPATH = $(OBJDIR):chemistry_biogenic megan

# Options reminders:
# -w suppresses warning messages

# For programming (faster compiling):
OPTS1 = -ffree-line-length-none -cpp -J$(OBJDIR) -I$(OBJDIR) -fcheck=all -ffpe-trap=invalid,zero,overflow
#-Wall -Wextra -Wsurprising -Warray-temporaries -Wtabs -Wno-character-truncation

#for debugging:
#OPTS1 = -ffree-line-length-none -cpp -J$(OBJDIR) -I$(OBJDIR) -fcheck=all -Wall -Wextra -g -O0 -ffpe-trap=invalid,zero,overflow -fbounds-check

#this runs 2x faster, but slower compilation
OPTS = -ffree-line-length-none -cpp -J$(OBJDIR) -I$(OBJDIR) -fcheck=all -ffpe-trap=invalid,zero,overflow -O3 
#OPTS = -ffree-line-length-none -cpp -J$(OBJDIR) -I$(OBJDIR) -fcheck=all -Wall -Wextra -g -O0 -ffpe-trap=invalid,zero,overflow -fbounds-check

# OPT = -ffpe-trap=invalid,zero,overflow

M7_OPTS = $(OPTS)

CHEM_OPTS = $(OPTS1)

# MAIN_OBJECTS = reaction_rates.o thermodynamics.o acidity.o dynamics.o diffusivity.o constants.o output.o opkdmain.o opkda1.o opkda2.o
MAIN_OBJECTS = reaction_rates.o thermodynamics.o acidity.o dynamics.o constants.o output.o
CHEM_OBJECTS = second_Precision.o second_Parameters.o second_Initialize.o second_Util.o second_Monitor.o second_JacobianSP.o \
               second_LinearAlgebra.o second_Jacobian.o second_Global.o second_Rates.o second_Integrator.o second_Function.o \
               second_Model.o second_Main.o
MEGAN_OBJECTS = Megan_version_2.o M2_canopy.o M2_SPC_MGN.o M2_LD_FCT.o M2_RHO_SPC.o M2_TEMPD_PRM.o M2_REL_EM_ACT.o M2_gamma_etc.o \
                LAI_Hyy_month.o          
ACDC_OBJECTS = get_acdc_J.o driver.o acdc_system.o acdc_equations.o monomer_settings.o solution_settings.o \
               vode.o vodea.o        
M7_OBJECTS = mo_aero_m7.o mo_aero_nucl.o m7_cumnor.o m7_dgas_org.o m7.o m7_averageproperties.o \
             m7_dnum.o m7_dconc.o m7_equil.o m7_nuck.o m7_coaset.o m7_delcoa.o m7_equimix.o \
             m7_concoag.o m7_dgas.o m7_equiz.o               			   
			   
# Make automatic variables reminder:
#   $@   target
#   $<   first prerequisite
#   $^   all dependencies, duplicates removed

all: adchem.exe

# Here is the link step:

adchem.exe: adchem.o $(MAIN_OBJECTS) $(CHEM_OBJECTS) $(MEGAN_OBJECTS) $(ACDC_OBJECTS) $(M7_OBJECTS)
	 $(F90) $(OPTS) $^ -o $@

# Here are the compile steps:

# Main program

$(OBJDIR)/adchem.o: adchem_2box.f90 $(MAIN_OBJECTS) $(CHEM_OBJECTS) $(MEGAN_OBJECTS) $(ACDC_OBJECTS) $(M7_OBJECTS)
	 $(F90) $(OPTS) -c $< -o $@

# Modules for the main program

$(OBJDIR)/reaction_rates.o: reaction_rates_20191031.f90 constants.o $(CHEM_OBJECTS)
	 $(F90) $(OPTS) -c $< -o $@

$(OBJDIR)/thermodynamics.o: thermodynamicsDMS_DMA.f90 constants.o acidity.o $(CHEM_OBJECTS)
	 $(F90) $(OPTS) -c $< -o $@	 
	 
$(OBJDIR)/dynamics.o: dynamicsDMS_atm.f90 constants.o $(CHEM_OBJECTS)
	 $(F90) $(OPTS) -c $< -o $@

#$(OBJDIR)/diffusivity.o: diffusivity.f90 constants.o $(CHEM_OBJECTS)
#	 $(F90) $(OPTS) -c $< -o $@	 	 

$(OBJDIR)/constants.o: constants.f90 $(CHEM_OBJECTS)
	 $(F90) $(OPTS) -c $< -o $@

$(OBJDIR)/acidity.o: acidityDMS_DMA.f90 $(CHEM_OBJECTS)
	 $(F90) $(OPTS) -c $< -o $@

$(OBJDIR)/output.o: output.f90 constants.o $(CHEM_OBJECTS)
	 $(F90) $(OPTS) -c $< -o $@	 	 

#$(OBJDIR)/multilayer.o: multilayer.f90 constants.o opkdmain.o opkda1.o opkda2.o $(CHEM_OBJECTS) 
#	 $(F90) $(OPTS) -c $< -o $@
	

# ODEPACK is Fortran 77, hence -std=legacy.
# -w turns off warnings; we are not going to modify ODEPACK code even
# if it gives some warnings.

$(OBJDIR)/opkda1.o: opkda1.f
	$(F90) $(OPTS) -std=legacy -w -c opkda1.f
$(OBJDIR)/opkda2.o: opkda2.f# 	
	$(F90) $(OPTS) -std=legacy -c opkda2.f
$(OBJDIR)/opkdmain.o: opkdmain.f
	$(F90) $(OPTS) -std=legacy -c opkdmain.f

# Download ODEPACK code, if not present:
opkdmain.f:
	wget http://www.netlib.org/odepack/opkdmain.f
opkda1.f:
	wget http://www.netlib.org/odepack/opkda1.f
opkda2.f:
	wget http://www.netlib.org/odepack/opkda2.f
	
# Chemistry

$(OBJDIR)/second_Precision.o: second_Precision.f90
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Parameters.o: second_Parameters.f90 second_Precision.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Global.o: second_Global.f90 second_Parameters.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Initialize.o: second_Initialize.f90 second_Parameters.o second_Global.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Util.o: second_Util.f90 second_Parameters.o second_Monitor.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Monitor.o: second_Monitor.f90
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_JacobianSP.o: second_JacobianSP.f90
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_LinearAlgebra.o: second_LinearAlgebra.f90 second_Parameters.o second_JacobianSP.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Jacobian.o: second_Jacobian.f90 second_Parameters.o second_JacobianSP.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Rates.o: second_Rates.f90 second_Parameters.o second_Global.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Integrator.o: second_Integrator.f90 second_Precision.o second_Global.o second_Parameters.o second_JacobianSP.o \
second_LinearAlgebra.o second_Function.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Function.o: second_Function.f90 second_Parameters.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Model.o: second_Model.f90 second_Precision.o second_Parameters.o second_Global.o second_Function.o \
second_Integrator.o second_Rates.o second_Jacobian.o second_LinearAlgebra.o second_Monitor.o second_Util.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@
$(OBJDIR)/second_Main.o: second_Main.f90 second_Model.o second_Initialize.o
	 $(F90) $(CHEM_OPTS) -c $< -o $@

# MEGAN

$(OBJDIR)/LAI_Hyy_month.o: LAI_Hyy_month.f90
	 $(F90) $(OPTS) -c $< -o $@	 	 
	
$(OBJDIR)/M2_canopy.o: megan/M2_canopy.F90
	 $(F90) $(OPTS) -c $< -o $@	 	 
   
$(OBJDIR)/M2_LD_FCT.o: M2_LD_FCT.f90
	 $(F90) $(OPTS) -c $< -o $@	 	 
	
$(OBJDIR)/M2_RHO_SPC.o: M2_RHO_SPC.f90
	 $(F90) $(OPTS) -c $< -o $@	 	 
	
$(OBJDIR)/M2_TEMPD_PRM.o: M2_TEMPD_PRM.f90
	 $(F90) $(OPTS) -c $< -o $@	 	 
	
$(OBJDIR)/M2_REL_EM_ACT.o: M2_REL_EM_ACT.f90
	 $(F90) $(OPTS) -c $< -o $@	 	 
	
$(OBJDIR)/M2_SPC_MGN.o: M2_SPC_MGN.f90
	 $(F90) $(OPTS) -c $< -o $@	 	 

$(OBJDIR)/M2_gamma_etc.o: M2_gamma_etc.f90 M2_TEMPD_PRM.o M2_REL_EM_ACT.o
	 $(F90) $(OPTS) -c $< -o $@	 	 
	
$(OBJDIR)/Megan_version_2.o: Megan_version_2.f90 M2_canopy.o M2_gamma_etc.o \
                   M2_LD_FCT.o M2_RHO_SPC.o M2_SPC_MGN.o 
	 $(F90) $(OPTS) -c $< -o $@
	 
# ACDC
$(OBJDIR)/get_acdc_J.o: get_acdc_AMsD.f90 acdc_system.o driver.o vode.o vodea.o
	 $(F90) $(OPTS) -c $< -o $@
 
$(OBJDIR)/driver.o: driver_acdc_AMsD.f90 acdc_system.o solution_settings.o \
                   monomer_settings.o
	 $(F90) $(OPTS) -c $< -o $@

$(OBJDIR)/acdc_system.o: acdc_system_AMsD_new.f90
	 $(F90) $(OPTS) -c $< -o $@
	 
$(OBJDIR)/acdc_equations.o: acdc_equations_AMsD_new.f90 monomer_settings_acdc_MSA.o
	 $(F90) $(OPTS) -c $< -o $@

$(OBJDIR)/monomer_settings.o: monomer_settings_acdc_MSA.f90 acdc_system.o
	 $(F90) $(OPTS) -c $< -o $@
 
$(OBJDIR)/solution_settings.o: solution_settings.f90
	 $(F90) $(OPTS) -c $< -o $@

$(OBJDIR)/vode.o: vode.f
	gfortran -std=legacy -O3 -c $< -o $@

$(OBJDIR)/vodea.o: vodea.f
	gfortran -std=legacy -O3 -c $< -o $@
	
# M7
$(OBJDIR)/mo_aero_m7.o: mo_aero_m7.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/mo_aero_nucl.o: mo_aero_nucl.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_cumnor.o: m7_cumnor.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_dgas_org.o: m7_dgas_org.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7.o: m7.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_averageproperties.o: m7_averageproperties.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_dnum.o: m7_dnum.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_nuck.o: m7_nuck.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_dconc.o: m7_dconc.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_equil.o: m7_equil.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_coaset.o: m7_coaset.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_delcoa.o: m7_delcoa.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_equimix.o: m7_equimix.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_concoag.o: m7_concoag.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_dgas.o: m7_dgas.F90
	 $(F90) $(M7_OPTS) -c $< -o $@
$(OBJDIR)/m7_equiz.o: m7_equiz.F90
	 $(F90) $(M7_OPTS) -c $< -o $@

#$(OBJDIR)/vode.o: vode.f
#	$(F90) $(OPTS) -std=legacy -w -c vode.f
#
#$(OBJDIR)/vodea.o: vodea.f 	
#	$(F90) $(OPTS) -std=legacy -c vodea.f

CHEM_MODS = $(CHEM_OBJECTS:.o=.mod)
MAIN_MODS = $(MAIN_OBJECTS:.o=.mod)
M7_MODS  = $(M7_OBJECTS:.o=.mod)
ACDC_MODS  = $(ACDC_OBJECTS:.o=.mod)
MEGAN_MODS  = $(MEGAN_OBJECTS:.o=.mod)


# This entry allows you to type 'make clean' to get rid of all object and module files 

# With 'clean', don't remove chemistry object files, since it takes very long (minutes, or tens of minutes if big chemistry)
# to compile them, and there usually is no need to recompile them
clean:
	-@cd $(OBJDIR) ; rm adchem1D.o $(MAIN_OBJECTS) $(MEGAN_OBJECTS) $(ACDC_OBJECTS) $(M7_OBJECTS)   2>/dev/null || true
	-@rm adchem1D.exe                                 2>/dev/null || true

# If you really want to remove chemistry objects too, use this
cleanall:
	-@cd $(OBJDIR) ; rm $(MAIN_OBJECTS) $(CHEM_OBJECTS) $(MEGAN_OBJECTS) $(ACDC_OBJECTS) $(M7_OBJECTS)   2>/dev/null || true
	-@cd $(OBJDIR) ; rm $(MAIN_MODS) $(M7_MODS) $(ACDC_MODS) $(CHEM_MODS)  $(MEGAN_OBJECTS)   2>/dev/null || true
	-@cd $(OBJDIR) ; rm adchem1D.o                                    2>/dev/null || true
	-@rm adchem1D.exe                                                 2>/dev/null || true

# Some explanation for the clean commands:
# -            lets make continue when a command gives an error
# @            suppresses echoing the command
# 2>/dev/null  hides the error messages from e.g. rm command, if files don't exist
# || true      hides the message that there was an error in the command
#
# ref. http://stackoverflow.com/questions/3148492/makefile-silent-remove

