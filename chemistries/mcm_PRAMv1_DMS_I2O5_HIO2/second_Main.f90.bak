! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
! 
! Main Program File
! 
! Generated by KPP-2.2 symbolic chemistry Kinetics PreProcessor
!       (http://www.cs.vt.edu/~asandu/Software/KPP)
! KPP is distributed under GPL, the general public licence
!       (http://www.gnu.org/copyleft/gpl.html)
! (C) 1995-1997, V. Damian & A. Sandu, CGRER, Univ. Iowa
! (C) 1997-2005, A. Sandu, Michigan Tech, Virginia Tech
!     With important contributions from:
!        M. Damian, Villanova University, USA
!        R. Sander, Max-Planck Institute for Chemistry, Mainz, Germany
! 
! File                 : second_Main.f90
! Time                 : Mon Jan 16 11:06:22 2017
! Working directory    : /Users/boy/Documents/kpp/workdir4
! Equation file        : second.kpp
! Output root filename : second
! 
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~



! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
! 
! MAIN - Main program - driver routine
!   Arguments :
! 
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MODULE second_Main
  ! A driver option for calling KPP as a module, from an external program
  ! by Sampo Smolander, 2008

  USE second_Model
  USE second_Initialize, ONLY: Initialize
  
  IMPLICIT NONE

  PRIVATE
  PUBLIC :: KPP_SetUp, KPP_Proceed

  REAL(kind=dp) :: T, DVAL(NSPEC)
  REAL(kind=dp) :: RSTATE(20)
  INTEGER :: ICNTRL(20) ! Added by Sampo Smolander
  INTEGER :: i

CONTAINS
  
!~~~> Initialization 

  SUBROUTINE KPP_SetUp()
    STEPMIN = 0.0d0
    STEPMAX = 0.0d0
    ICNTRL = (/ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 /)
    DO i=1,NVAR
       RTOL(i) = 1.0d-3
       ATOL(i) = 1.0d-4
    END DO
    CALL Initialize()
  END SUBROUTINE KPP_SetUp

!~~~> Time loop

  SUBROUTINE KPP_Proceed(CONS,TSTARTp,TENDp,TEMPp,RHp,PRESSp,O2p,N2p,Mp,H2Op,RES1p,RES2p,CSp,cwp,H_ionp,OH_ionp,Jp,KVALUESp)
  
    IMPLICIT NONE
    REAL(kind=dp), INTENT(INOUT) :: CONS(NSPEC)
    REAL(kind=dp), INTENT(IN) :: TSTARTp,TENDp
    REAL(kind=dp), INTENT(IN) :: TEMPp,RHp,PRESSp,O2p,N2p,Mp,H2Op,RES1p,RES2p,cwp,H_ionp,OH_ionp
	REAL(kind=dp) :: Rprim,kb,pi
	REAL(kind=dp), INTENT(IN), DIMENSION(51) :: CSp
    REAL(kind=dp), INTENT(IN) :: Jp(NPHOT),KVALUESp(NKVALUES)
	REAL(kind=dp), DIMENSION(52) :: kmt_molec,H_molec,k_molec,Hprim
    REAL(kind=dp) :: T1,T2,T_factor

!    T = TSTARTp
!    TIME = T
    T1 = TSTARTp
    T2 = TENDp

    TEMP  = TEMPp
    RH    = RHp
    PRESS = PRESSp
    O2    = O2p
    N2    = N2p
    M     = Mp
    H2O   = H2Op
    RES1  = RES1p
    RES2  = RES2p
    
	cw=cwp              ! Particle (cloud) liquid water content (kg/cm^3)
	H_ion=H_ionp        ! [H+] concentration (mol/kg)
	OH_ion=OH_ionp        ! [OH-] concentration (mol/kg)
	Na = 6.022d23 		! Avogadro's constant [molec/mol]
	kb = 1.381D-23  	! J/K  Boltzmanns constant
	pi = 2*ASIN(1._dp)
	Rprim=82.06D0 ! cm^3 atm mol^-1 K^-1
	kmt_molec = CSp ! Condensation sink (s^-1)
    T_factor=(98D-3*EXP(-11.695D0+10156D0*(1D0/360.15D0-1D0/TEMP+0.38D0/545D0*(1D0+LOG(360.15/TEMP)-360.15/TEMP))))/ &
    (98D-3*exp(-11.695D0+10156D0*(1D0/360.15D0-1D0/298.15+0.38D0/545D0*(1D0+LOG(360.15/298.15)-360.15/298.15)))) ! For H2SO4 but assumed the same for MSA and HIO3

! Henry’s Law constants (Table S10, Bräuer et al., 2013)
H_molec(1)= 9.15D-2*EXP(2490D0*(1D0/TEMP-1D0/298D0))  !Cl2
H_molec(2)= 0.2D0 !Cl
H_molec(3)= 660D0*EXP(5862D0*(1D0/TEMP-1D0/298D0)) !ClO
H_molec(4)= 1D0*EXP(-3300D0*(1D0/TEMP-1D0/298D0)) !ClO2
H_molec(5)= (1.97D6*EXP(30.19*(298.15/TEMP-1D0)+19.91*(1D0+LOG(298.15/TEMP)-298.15/TEMP)))/(1.72D6*EXP(23.15*(298.15/TEMP-1D0))) !HCl
H_molec(6)= 660D0*EXP(5862D0*(1D0/TEMP-1D0/298D0)) !HOCl
H_molec(7)= 5D-2 !ClNO
H_molec(8)= 4.6D-2 !ClNO2
H_molec(9)= 2.1D5*EXP(8700D0*(1D0/TEMP-1D0/298D0)) !ClNO3
H_molec(10)= 0.76D0*EXP(4100D0*(1D0/TEMP-1D0/298D0)) !Br2
H_molec(11)= 1.2D0 !Br
H_molec(12)= 93D0*EXP(5862D0*(1D0/TEMP-1D0/298D0)) !BrO
H_molec(13)= 1.3*EXP(10239D0*(1D0/TEMP-1D0/298D0)) !HBr
H_molec(14)= 93D0*EXP(5862D0*(1D0/TEMP-1D0/298D0)) !HOBr
H_molec(15)= 0.3 !BrNO2
H_molec(16)= 2.1D5*EXP(8700D0*(1D0/TEMP-1D0/298D0)) !BrNO3
H_molec(17)= 0.94D0*EXP(5600D0*(1D0/TEMP-1D0/298D0)) !BrCl
H_molec(18)= 3D0*EXP(4431D0*(1D0/TEMP-1D0/298D0)) !I2
H_molec(19)= 8D-2 !I
H_molec(20)= 450D0*EXP(5862D0*(1D0/TEMP-1D0/298D0)) !IO
H_molec(21)= 2.1D5*EXP(8700D0*(1D0/TEMP-1D0/298D0)) !OIO
H_molec(22)= 2.1D5*EXP(8700D0*(1D0/TEMP-1D0/298D0)) !I2O2
H_molec(23)= 2.5D0*EXP(9800D0*(1D0/TEMP-1D0/298D0)) !HI
H_molec(24)= 450D0*EXP(5862D0*(1D0/TEMP-1D0/298D0)) !HOI
H_molec(25)= 5.02572D8*EXP(1.0695D4*(1D0/TEMP-1D0/298.15D0))  !HIO3 ! COSMOtherm, T dependence as H2SO4
H_molec(26)= 2.1D5*EXP(8700D0*(1D0/TEMP-1D0/298D0)) !INO2
H_molec(27)= 2.1D5*EXP(8700D0*(1D0/TEMP-1D0/298D0)) !INO3
H_molec(28)= 110D0*EXP(5600D0*(1D0/TEMP-1D0/298D0)) !ICl
H_molec(29)= 24D0*EXP(5600D0*(1D0/TEMP-1D0/298D0)) !IBr
H_molec(30)= 1.13D-2*EXP(7.72*(298D0/TEMP-1D0))  !O3 Jacobson, 2005 (Table B7)
H_molec(31)= 2.5D1*EXP(22.21*(298D0/TEMP-1D0))  ! OH  Jacobson, 2005 (Table B7)	
H_molec(32)= 9.1D2*101.325*exp(6600*(1D0/TEMP-1D0/298D0))! H2O2 Warneck and Williams (2012) 7.45D4*EXP(22.21*(298D0/TEMP-1D0))  ! H2O2 Jacobson, 2005 (Table B7)
H_molec(33)= 0.56D0*EXP(4480D0*(1D0/TEMP-1D0/298D0))! 5.3D-3*101.325*EXP(3500D0*(1D0/TEMP-1D0/298D0)) ! Sander et al. (2011)  !DMS, Hoffmann et al., 2016
H_molec(34)= 2.43D5*EXP(2580D0*(1D0/TEMP-1D0/298D0)) !DMSO, Hoffmann et al., 2016 ! 9.4D2*101.325*EXP(1300D0*(1D0/TEMP-1D0/298D0))! Watts and Brimblecombe (1987)
H_molec(35)= 1.18D6*EXP(5390D0*(1D0/TEMP-1D0/298D0)) !DMSO2, Hoffmann et al., 2016 ! 4.9D2 De Bruyn et al (1994) 
H_molec(36)= 1.4287D6*EXP(9.4632D3*(1D0/TEMP-1D0/298.15D0)) !MSIA, COSMO-therm & assumed T dependence 
H_molec(37)= 1.33D4 ! HPMTF COSMOtherm (non-hydrated form)
H_molec(38)= 1.22D0*EXP(10.55*(298D0/TEMP-1D0)) !SO2 Jacobson, 2005 (Table B7)
H_molec(39)= 2D3*EXP(22.28*(298D0/TEMP-1D0)) !HO2 Jacobson, 2005 (Table B7)
H_molec(40)= 2.1D5*EXP(29.19*(298D0/TEMP-1D0)) !NO3 Jacobson, 2005 (Table B7)
H_molec(41)= 1.4D-5 !RO2 Jacobson, 2005 (Table B7)
H_molec(42)= 3.46D0*EXP(8.19*(298D0/TEMP-1D0)) !HCHO Jacobson, 2005 (Table B7)
H_molec(43)= 1D-2*EXP(8.38*(298D0/TEMP-1D0)) !NO2 Jacobson, 2005 (Table B7)
H_molec(44)= 1.3D-3 !O2 
H_molec(45)= 1D5 !SO3  ! Assumed 
H_molec(46)= 57.6*EXP(13.79*(298./TEMP-1D0)-5.39*(1D0+log(298./TEMP)-298./TEMP)) ! mol/(kg atm) NH3(g)<->NH3(aq)
H_molec(47)= 57.6*EXP(13.79*(298./TEMP-1D0)-5.39*(1D0+log(298./TEMP)-298./TEMP)) ! mol/(kg atm) DMA(g)<->DMA(aq)
H_molec(48)= 1.33D4 ! HPMTF COSMOtherm (non-hydrated form) assumed the same for HOOCH2SCO
H_molec(49)=2.1D5*EXP(29.17*(298.15/TEMP-1D0)+16.83*(1D0+LOG(298.15/TEMP)-298.15/TEMP)) ! ! mol/(kg atm) HNO3(g)<->HNO3(aq)
H_molec(50)=1D0/(98D-3*exp(-11.695D0+10156D0*(1D0/360.15D0-1D0/TEMP+0.38D0/545D0*(1D0+log(360.15/TEMP)-360.15/TEMP)))) !  Kulmala and Laaksonen (1990) (atm) modified by Noppel et al., 2002  ! mol/(kg atm) H2SO4(g)<->H2SO4(aq)
H_molec(51)= 1D1*7.7716275D7*EXP(9.9034D3*(1D0/TEMP-1D0/298.15D0)) ! mol/(kg atm) Henry's law coeff for CH3SO2H(g)<->CH3SO2H(aq), COSMOtherm! MSA COSMOtherm 
H_molec(52)= 1D6 ! mol/(kg atm) Henry's law coeff for HIO2(g)<->HIO2(aq), Guess 


   Hprim=cw*Rprim*TEMP*H_molec ! Dimensionless Henry's constant (Jacobson, 2005, eq. 19.37)  
   
   kCl2_g_aq=kmt_molec(1)
   kCl2_aq_g=kmt_molec(1)/Hprim(1)  
   kCl_g_aq=kmt_molec(2)
   kCl_aq_g=kmt_molec(2)/Hprim(2)
   kClO_g_aq=kmt_molec(3)
   kClO_aq_g=kmt_molec(3)/Hprim(3) !kClO2_g_aq=kmt_molec(4) 
   kClO2_aq_g=kmt_molec(4)/Hprim(4)
   kHCl_g_aq=kmt_molec(5) 
   kHCl_aq_g=kmt_molec(5)/Hprim(5) 
   kHOCl_g_aq=kmt_molec(6)
   kHOCl_aq_g=kmt_molec(6)/Hprim(6)
   kClNO_g_aq=kmt_molec(7)
   kClNO_aq_g=kmt_molec(7)/Hprim(7)
   kClNO2_g_aq=kmt_molec(8)
   kClNO2_aq_g=kmt_molec(8)/Hprim(8)
   kClNO3_g_aq=kmt_molec(9)
   kClNO3_aq_g=kmt_molec(9)/Hprim(9)
   kBr2_g_aq=kmt_molec(10)
   kBr2_aq_g=kmt_molec(10)/Hprim(10)
   kBr_g_aq=kmt_molec(11)
   kBr_aq_g=kmt_molec(11)/Hprim(11)
   kBrO_g_aq=kmt_molec(12)
   kBrO_aq_g=kmt_molec(12)/Hprim(12)
   kHBr_g_aq=kmt_molec(13)
   kHBr_aq_g=kmt_molec(13)/Hprim(13)
   kHOBr_g_aq=kmt_molec(14)
   kHOBr_aq_g=kmt_molec(14)/Hprim(14)
   kBrNO2_g_aq=kmt_molec(15)
   kBrNO2_aq_g=kmt_molec(15)/Hprim(15)
   kBrNO3_g_aq=kmt_molec(16)
   kBrNO3_aq_g=kmt_molec(16)/Hprim(16)
   kBrCl_g_aq=kmt_molec(17)
   kBrCl_aq_g=kmt_molec(17)/Hprim(17)
   kI2_g_aq=kmt_molec(18)
   kI2_aq_g=kmt_molec(18)/Hprim(18)
   kI_g_aq=kmt_molec(19)
   kI_aq_g=kmt_molec(19)/Hprim(19)
   kIO_g_aq=kmt_molec(20)
   kIO_aq_g=kmt_molec(20)/Hprim(20)
   kOIO_g_aq=kmt_molec(21)
   kOIO_aq_g=kmt_molec(21)/Hprim(21)
   kI2O2_g_aq=kmt_molec(22)
   kI2O2_aq_g=kmt_molec(22)/Hprim(22)
   kHI_g_aq=kmt_molec(23)
   kHI_aq_g=kmt_molec(23)/Hprim(23)
   kHOI_g_aq=kmt_molec(24)
   kHOI_aq_g=kmt_molec(24)/Hprim(24)
   kHIO3_g_aq=kmt_molec(25)
   kHIO3_aq_g=kmt_molec(25)/Hprim(25)
   kINO2_g_aq=kmt_molec(26)
   kINO2_aq_g=kmt_molec(26)/Hprim(26)
   kINO3_g_aq=kmt_molec(27)
   kINO3_aq_g=kmt_molec(27)/Hprim(27)
   kICl_g_aq=kmt_molec(28)
   kICl_aq_g=kmt_molec(28)/Hprim(28)
   kIBr_g_aq=kmt_molec(29)
   kIBr_aq_g=kmt_molec(29)/Hprim(29)
   kO3_g_aq=kmt_molec(30)
   kO3_aq_g=kmt_molec(30)/Hprim(30)
   kOH_g_aq=kmt_molec(31)
   kOH_aq_g=kmt_molec(31)/Hprim(31)
   kH2O2_g_aq=kmt_molec(32)
   kH2O2_aq_g=kmt_molec(32)/Hprim(32) 
   kDMS_g_aq=kmt_molec(33)
   kDMS_aq_g=kmt_molec(33)/Hprim(33)
   kDMSO_g_aq=kmt_molec(34)
   kDMSO_aq_g=kmt_molec(34)/Hprim(34)
   kDMSO2_g_aq=kmt_molec(35)
   kDMSO2_aq_g=kmt_molec(35)/Hprim(35)
   kMSIA_g_aq=kmt_molec(36)
   kMSIA_aq_g=kmt_molec(36)/Hprim(36)
   kHPMTF_g_aq=kmt_molec(37)
   kHPMTF_aq_g=kmt_molec(37)/Hprim(37)
   kSO2_g_aq=kmt_molec(38)
   kSO2_aq_g=kmt_molec(38)/Hprim(38)
   kHO2_g_aq=kmt_molec(39)
   kHO2_aq_g=kmt_molec(39)/Hprim(39)
   kNO3_g_aq=kmt_molec(40)
   kNO3_aq_g=kmt_molec(40)/Hprim(40)
   kRO2_g_aq=kmt_molec(41)
   kRO2_aq_g=kmt_molec(41)/Hprim(41)
   kHCHO_g_aq=kmt_molec(42)
   kHCHO_aq_g=kmt_molec(42)/Hprim(42)
   kNO2_g_aq=kmt_molec(43)
   kNO2_aq_g=kmt_molec(43)/Hprim(43)
   kO2_g_aq=kmt_molec(44)
   kO2_aq_g=kmt_molec(44)/Hprim(44)
   kSO3_g_aq=kmt_molec(45)
   kSO3_aq_g=kmt_molec(45)/Hprim(45)
   kNH3_g_aq=kmt_molec(46)
   kNH3_aq_g=kmt_molec(46)/Hprim(46)
   kDMA_g_aq=kmt_molec(47)
   kDMA_aq_g=kmt_molec(47)/Hprim(47)
   kHOOCH2SCO_g_aq=kmt_molec(48)
   kHOOCH2SCO_aq_g=kmt_molec(48)/Hprim(48)
   kHNO3_g_aq=kmt_molec(49)
   kHNO3_aq_g=kmt_molec(49)/Hprim(49)
   kH2SO4_g_aq=kmt_molec(50)
   kH2SO4_aq_g=kmt_molec(50)/Hprim(50)
   kMSA_g_aq = kmt_molec(51)
   kMSA_aq_g = kmt_molec(51)/Hprim(51)
   kHIO2_g_aq=kmt_molec(52)
   kHIO2_aq_g=kmt_molec(52)/Hprim(52)


    J     = Jp

    KMT01   = KVALUESp(1)
    KMT02   = KVALUESp(2)
    KMT03   = KVALUESp(3)
    KMT04   = KVALUESp(4)
    KMT05   = KVALUESp(5)
    KMT06   = KVALUESp(6)
    KMT07   = KVALUESp(7)
    KMT08   = KVALUESp(8)
    KMT09   = KVALUESp(9)
    KMT10   = KVALUESp(10)
    KMT11   = KVALUESp(11)
    KMT12   = KVALUESp(12)
    KMT13   = KVALUESp(13)
    KMT14   = KVALUESp(14)
    KMT15   = KVALUESp(15)
    KMT16   = KVALUESp(16)
    KMT17   = KVALUESp(17)
    KMT18   = KVALUESp(18)
    KFPAN   = KVALUESp(19)
    KBPAN   = KVALUESp(20)
    KRO2NO  = KVALUESp(21)
    KRO2HO2 = KVALUESp(22)
    KAPHO2  = KVALUESp(23)
    KAPNO   = KVALUESp(24)
    KRO2NO3 = KVALUESp(25)
    KNO3AL  = KVALUESp(26)
    KDEC    = KVALUESp(27)
    KROPRIM = KVALUESp(28)
    KROSEC  = KVALUESp(29)
    KCH3O2  = KVALUESp(30)
    K298CH3O2 = KVALUESp(31)
    K_h2so4 = KVALUESp(32)
    K_CI = KVALUESp(33)
    KMT34 = KVALUESp(34)
    KMT35 = KVALUESp(35)
    KMT36 = KVALUESp(36)
    KMT37 = KVALUESp(37)
    KMT38 = KVALUESp(38)
    KMT39 = KVALUESp(39)
    KMT40 = KVALUESp(40)
    KMT41 = KVALUESp(41)
    KMT42 = KVALUESp(42)
	
	! New Chlorine chemistry
	KMT46 = KVALUESp(46) ! Not the same as in Bräuer !!!!
	KMT47 = KVALUESp(47) ! OK!   
	KMT48 = KVALUESp(48) ! Not the same as in Bräuer !!!!
    KMT49 = KVALUESp(49) ! Not the same as in Bräuer !!!!
    KMT50 = KVALUESp(50)
    KMT51 = KVALUESp(51)
    KMT52 = KVALUESp(52)
    KMT53 = KVALUESp(53)

	KMT54 = KVALUESp(54)
	KMT55 = KVALUESp(55)
	KMT56 = KVALUESp(56)
	KMT57 = KVALUESp(57)
	KMT58 = KVALUESp(58)
	KMT59 = KVALUESp(59)
	KMT60 = KVALUESp(60)
	KMT61 = KVALUESp(61)
	KMT62 = KVALUESp(62)
	KMT63 = KVALUESp(63)
	KMT64 = KVALUESp(64)
	KMT65 = KVALUESp(65)
	KMT66 = KVALUESp(66)
	KMT67 = KVALUESp(67)

	where (CONS<0D0) CONS=0D0
    C = CONS
    ! Update_RCONST and INTEGRATE will operate on C
    CALL Update_RCONST()
    CALL INTEGRATE( TIN = T1, TOUT = T2, RSTATUS_U = RSTATE, ICNTRL_U = ICNTRL )
    CONS = C
	
	where (CONS<0D0) CONS=0D0
!    T = RSTATE(1)
!    TIME = T
  END SUBROUTINE KPP_Proceed

END MODULE second_Main
! End of MAIN function
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


